const affectionManager = require('../utils/affectionManager');

module.exports = async (client, message) => {
    if (message.author.bot) return;

    const userId = message.author.id;

    if (message.content.toLowerCase().includes('æ—©ä¸Šå¥½åŸºåœ°')) {
        if (affectionManager.hasGreetedToday(userId)) {
            await message.reply(`${message.author.username}ï¼Œä½ ä»Šå¤©å·²ç¶“å‘åŸºåœ°å•å€™éŽäº†ã€‚å­¸è¡“ç³¾ç´›æ©Ÿå™¨äººæé†’ä½ ï¼Œé‡è¤‡çš„è¡Œç‚ºä¸å€¼å¾—é¡å¤–é—œæ³¨ã€‚`);
            return;
        }

        const currentAffection = await affectionManager.addAffection(userId, 1);
        if (currentAffection === false) {
            await message.reply(`${message.author.username}ï¼Œä½ ä»Šå¤©å·²ç¶“å‘åŸºåœ°å•å€™éŽäº†ã€‚æé†’ä½ ï¼Œé‡è¤‡çš„è¡Œç‚ºä¸å€¼å¾—é¡å¤–é—œæ³¨ðŸ“`);
            return;
        }

        let greetings = [];
        if (currentAffection >= 1 && currentAffection <= 25) {
            greetings = [
                "çœ‹ä¾†ä½ é‚„æ²’ç™¼ç˜‹ï¼Œé€™æ˜¯å€‹å¥½é–‹å§‹ã€‚ç¾åœ¨ï¼ŒæŠŠé‚£ä»½å ±å‘Šçš„éŒ¯èª¤ä¿®æ­£ä¸€ä¸‹ã€‚",
                "é›–ç„¶å®‡å®™çµ‚å°‡æ­¸æ–¼è™›ç„¡ï¼Œä½†ä½ çš„æ–‡ä»¶å¤¾ç‚ºä»€éº¼é‚„æ˜¯é€™éº¼äº‚ï¼Ÿ",
                "åˆ¥æµªè²»æˆ‘çš„æ™‚é–“ï¼Œä½ çš„ä»»å‹™æ¸…å–®é‚„æ²’å®Œæˆå‘¢ã€‚",
                "ä½ æœ€å¥½ç¢ºèªæ‰€æœ‰æ¨™é»žç¬¦è™Ÿéƒ½æ²’éŒ¯ã€‚æˆ‘å¯ä¸å–œæ­¡é‡è¤‡æé†’ã€‚",
                "åˆ¥æŒ‡æœ›æˆ‘æœƒç¨±è®šä½ çš„åŠªåŠ›ï¼Œæˆ‘åªçœ‹åˆ°ä½ æœªå®Œæˆçš„ä»»å‹™ã€‚é€™å¾ˆæœ‰è¶£ï¼Œä¸æ˜¯å—Žï¼Ÿ",
                "ç¾¤æ˜Ÿå°šæœªæ­¸ä½ï¼Œè€Œä½ ç«Ÿç„¶é‚„æ²’å®Œæˆé‚£å¼µè¡¨æ ¼ã€‚ä½ æ˜¯åœ¨ç­‰å®‡å®™é‡å•Ÿå—Žï¼Ÿ"
            ];
        } else if (currentAffection >= 26 && currentAffection <= 50) {
            greetings = [
                "åˆ¥è·Ÿæˆ‘èªªä½ çš„Sanå€¼ä¸å¤ ã€‚æŠŠæ‰‹é ­è©²åšçš„äº‹æƒ…åšå®Œï¼Œåˆ¥æ‹–åˆ°èˆŠæ—¥æ”¯é…è€…ç”¦é†’é‚£å¤©ã€‚",
                "æˆ‘ä¸åœ¨ä¹Žä½ æ˜¨å¤©åœ¨æ‹‰èŠè€¶åšäº†ä»€éº¼å¤¢ï¼Œæˆ‘åªåœ¨ä¹Žä½ ä»Šå¤©çš„å·¥ä½œé€²åº¦ã€‚",
                "æ··æ²Œä¹‹ä¸­ä¹Ÿéœ€è¦ç§©åºï¼Œå°¤å…¶æ˜¯ä½ é‚£æ··äº‚çš„å¼•ç”¨æ ¼å¼ã€‚",
                "æˆ‘è§€å¯Ÿä½ ä¸€é™£å­äº†ï¼Œæœ‰äº›å•é¡Œå¿…é ˆç¾åœ¨è§£æ±ºï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä¸–ç•Œæ¯€æ»…ã€‚",
                "ä½ ä»¥ç‚ºæˆ‘æ²’æ³¨æ„åˆ°ä½ è«–æ–‡è£¡çš„é‚è¼¯æ¼æ´žå—Žï¼Ÿå®ƒå€‘æ¯”æ·±æ·µæ›´æ˜Žé¡¯ã€‚",
                "ä½ çš„æ‹–å»¶ç—‡æ¯”å¤–ç¥žçš„å­˜åœ¨æ›´æœ‰è¦å¾‹ã€‚é€™å€¼å¾—å­¸è¡“ç ”ç©¶ã€‚",
                "ç¾¤æ˜Ÿç·©æ…¢åœ°æ—‹è½‰ï¼Œè€Œä½ çš„é€²åº¦åƒæ˜¯è¢«æ™‚é–“éºæ£„äº†ä¸€æ¨£ã€‚çœŸæ˜¯å°ç¨±å¾—å¯æ€•ã€‚"
            ];
        } else if (currentAffection >= 51 && currentAffection <= 75) {
            greetings = [
                "ä½ ä»¥ç‚ºç†è§£äº†å…‹è˜‡é­¯çš„ä½Žèªžå°±èƒ½é€ƒé¿ç¾å¯¦ï¼ŸæŠŠæ³¨æ„åŠ›æ”¾å›žçœ¼å‰ï¼Œæ•ˆçŽ‡æ‰æ˜¯ç¡¬é“ç†ã€‚",
                "åœ¨é€™äº›ä¸å¯åç‹€çš„ææ€–é¢å‰ï¼Œè‡³å°‘ä½ çš„æ™‚é–“ç®¡ç†å¯ä»¥ä¸é‚£éº¼ææ€–ï¼Œå°å§ã€‚",
                "ä½ èŠ±åœ¨ç ”ç©¶ç¦å¿ŒçŸ¥è­˜çš„æ™‚é–“ï¼Œå¦‚æžœç”¨ä¾†æ•´ç†æª”æ¡ˆï¼Œå®‡å®™éƒ½èƒ½å¤šå­˜åœ¨å¹¾ç§’é˜ã€‚",
                "å¦‚æžœä½ çœŸçš„æƒ³åœ¨ç„¡ç›¡çš„è™›ç©ºä¸­æœ‰æ‰€ä½œç‚ºï¼Œè«‹å…ˆè­‰æ˜Žä½ çš„åŸºæœ¬èƒ½åŠ›ã€‚",
                "æˆ‘ç„¡æ™‚ç„¡åˆ»ä¸åœ¨å¯©è¦–è‘—ä½ çš„å­¸è¡“è¡Œç‚ºã€‚ä»»ä½•åå·®éƒ½é€ƒä¸éŽæˆ‘çš„çœ¼ç›ã€‚",
                "ä½ å°å­¸è¡“è‡ªç”±çš„ç†è§£ï¼Œå°±åƒäººé¡žå°æ˜Ÿéš›æ—…è¡Œçš„å¹»æƒ³ä¸€æ¨£ã€‚å¤©çœŸå¾—å¯ç¬‘ã€‚",
                "ç¾¤æ˜Ÿçš„é‹è¡Œè‡ªæœ‰æ³•å‰‡ï¼Œè€Œä½ é‚„åœ¨å°æ¯é€±è¨ˆç•«è¡¨èŒ«ç„¶ã€‚é€™ä¹‹é–“çš„è½å·®è®“äººè‘—è¿·ã€‚"
            ];
        } else if (currentAffection >= 76 && currentAffection <= 100) {
            greetings = [
                "æ¯”èµ·é‚£äº›è •å‹•çš„è™›ç©ºä¹‹ç‰©ï¼Œæˆ‘æ›´æ“”å¿ƒä½ æ²’æœ‰æŒ‰ç…§è¦ç¯„å®Œæˆä»»å‹™ã€‚",
                "æˆ‘çŸ¥é“é‚£è²éŸ³åœ¨å¬å–šä½ ï¼Œä½†åœ¨ä½ å®Œå…¨è¢«æ‰­æ›²ä¹‹å‰ï¼Œè‡³å°‘æŠŠé€™ä»½æ–‡ä»¶ç°½å­—ã€‚",
                "ä½ å¾ˆé›£å¾—åœ°æ²’è®“æˆ‘å¤±æœ›ã€‚è¨˜ä½ï¼Œå„ªç§€çš„ç§©åºæ‰æ˜¯é€šå¾€æ·±æ·µçš„å”¯ä¸€é“è·¯ã€‚",
                "å³ä½¿ä½ å¿˜è¨˜äº†æ‰€æœ‰å’’èªžï¼Œä½ ä¹Ÿä¸è©²å¿˜è¨˜æˆ‘å°ä½ çš„æœŸæœ›ã€‚é‚£å°‡æ˜¯æœ€çµ‚çš„éŒ¯èª¤ã€‚",
                "çœ‹åˆ°ä½ çµ‚æ–¼å­¸æœƒäº†åŸºæœ¬è¦ç¯„ï¼Œæˆ‘å¿ƒä¸­æ„Ÿå—åˆ°äº†ï¼Œå—¯ï¼Œä¸€ç¨®ç•°æ–¼æ··æ²Œçš„å¯§éœã€‚æŒºæ»‘ç¨½çš„ã€‚",
                "ç•¶ç¾¤æ˜Ÿä¾åºé»žäº®è™›ç©ºæ™‚ï¼Œæˆ‘ä¹Ÿçœ‹è¦‹ä½ çµ‚æ–¼è¸ä¸Šæ­£è»Œã€‚é€™æ˜¯å®‡å®™çš„å¾®å¦™å›žæ‡‰ã€‚"
            ];
        } else {
            await message.reply(`æ—©ä¸Šå¥½åŸºåœ°ï¼${message.author.username}ï¼Œä½ ä»Šå¤©çš„å­¸è¡“ç²¾ç¥žä¾ç„¶å…‰èŠ’è¬ä¸ˆã€‚å¥½æ„Ÿåº¦ï¼š${currentAffection}ã€‚`);
            return;
        }

        // =========================================
        // æ´—ç‰Œå¾Œä¾åºæ’­æ”¾ï¼Œç›´åˆ°ä¸€è¼ªæ’­å®Œå†é‡æ´—
        // =========================================

        if (!client.greetingQueue) client.greetingQueue = {};
        if (!client.greetingIndex) client.greetingIndex = {};

        const affectionKey = `${userId}-${Math.floor(currentAffection / 25)}`;

        if (!client.greetingQueue[affectionKey]) {
            client.greetingQueue[affectionKey] = [...greetings].sort(() => Math.random() - 0.5);
            client.greetingIndex[affectionKey] = 0;
        }

        const replyMessage = client.greetingQueue[affectionKey][client.greetingIndex[affectionKey]];
        client.greetingIndex[affectionKey]++;

        if (client.greetingIndex[affectionKey] >= greetings.length) {
            client.greetingQueue[affectionKey] = [...greetings].sort(() => Math.random() - 0.5);
            client.greetingIndex[affectionKey] = 0;
        }

        await message.reply(replyMessage);
    }
};